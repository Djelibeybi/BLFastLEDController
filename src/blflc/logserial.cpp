#include "logserial.h"
#include <ESPAsyncWebServer.h>

void LogSerialClass::begin(unsigned long baud) {
    Serial.begin(baud);
}

void LogSerialClass::begin(AsyncWebServer* server, unsigned long baud, size_t bufferSize) {
    Serial.begin(baud);
    webSerial.begin(server);
    webSerial.setBuffer(bufferSize);
    webSerial.onMessage([](const std::string& msg) {
        Serial.print("[WebSerial RX] ");
        Serial.println(msg.c_str());
    });
}

void LogSerialClass::onMessage(std::function<void(const std::string&)> cb) {
    webSerial.onMessage(cb);
}

void LogSerialClass::setBuffer(size_t size) {
    webSerial.setBuffer(size);
}

int LogSerialClass::available() { return Serial.available(); }
int LogSerialClass::read() { return Serial.read(); }
int LogSerialClass::peek() { return Serial.peek(); }
void LogSerialClass::flush() { Serial.flush(); }

size_t LogSerialClass::write(uint8_t b) {
    Serial.write(b);
    webSerial.write(&b, 1);
    return 1;
}

size_t LogSerialClass::write(const uint8_t* buffer, size_t size) {
    Serial.write(buffer, size);
    webSerial.write(buffer, size);
    return size;
}

LogSerialClass::operator bool() { return (bool)Serial; }

LogSerialClass LogSerial;
