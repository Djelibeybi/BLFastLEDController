<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>BLFLC Authentication</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <canvas id="particleCanvas" style="background: rgb(20,80,49);"></canvas>
    <div id="container">
        <div id="header">
            <img id="logo" src="/blflc.svg" alt="BLFLC Logo">
            <h1>Authentication</h1>
        </div>

        <nav class="nav-menu" id="navMenu"></nav>

        <form id="authForm">
            <p style="margin-top: 0; color: #666; font-size: 13px;">
                Set a username and password to protect the web interface. Leave both empty to disable authentication.
            </p>

            <label for="webUser">Username</label>
            <input type="text" id="webUser" placeholder="e.g. admin" autocomplete="username">

            <label for="webPass">Password</label>
            <input type="password" id="webPass" placeholder="e.g. password" autocomplete="new-password">

            <label for="webPassConfirm">Confirm Password</label>
            <input type="password" id="webPassConfirm" placeholder="Confirm password" autocomplete="new-password">

            <button type="submit">Save</button>
        </form>

        <div id="status-bar">
            <span id="status-led">LED: <span id="ledReason">--</span></span>
            <span id="status-printer">Printer: <span id="printerState">--</span></span>
        </div>
    </div>

    <script src="particleCanvas.js"></script>
    <div id="toast"><span id="toast-icon"></span><span id="toast-msg">Placeholder</span></div>
    <script>
        function alertToast(type, message) {
            const toast = document.getElementById("toast");
            const icon = document.getElementById("toast-icon");
            const msg = document.getElementById("toast-msg");

            let iconChar = "i";
            let color = "#333";

            switch (type.toLowerCase()) {
                case "success": iconChar = "OK"; color = "#28a745"; break;
                case "error": iconChar = "X"; color = "#dc3545"; break;
                case "warning": iconChar = "!"; color = "#ffc107"; break;
                case "info": default: iconChar = "i"; color = "#17a2b8";
            }

            toast.style.backgroundColor = color;
            icon.textContent = iconChar;
            msg.textContent = message;
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 3000);
        }

        function buildNavMenu() {
            const nav = document.getElementById("navMenu");
            const currentPage = window.location.pathname;

            let links = [
                { href: "/", label: "LEDs" },
                { href: "/printer", label: "Printer" },
                { href: "/auth", label: "Auth" },
                { href: "/debug", label: "Debug" },
                { href: "/advanced", label: "Advanced" }
            ];

            // WiFi link only shown if networkType is wifi (checked via config)
            fetch("/config.json").then(res => res.json()).then(config => {
                if (config.networkType !== "ethernet") {
                    links.splice(1, 0, { href: "/wifi", label: "WiFi" });
                }
                renderNav(links, currentPage);
            }).catch(() => renderNav(links, currentPage));
        }

        function renderNav(links, currentPage) {
            const nav = document.getElementById("navMenu");
            nav.innerHTML = links.map(link =>
                `<a href="${link.href}" class="${currentPage === link.href ? 'active' : ''}">${link.label}</a>`
            ).join("");
        }

        document.getElementById("authForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const webUser = document.getElementById("webUser").value;
            const webPass = document.getElementById("webPass").value;
            const webPassConfirm = document.getElementById("webPassConfirm").value;

            if (webPass !== webPassConfirm) {
                alertToast("error", "Passwords do not match");
                return;
            }

            try {
                const res = await fetch("/submitAuth", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `webUser=${encodeURIComponent(webUser)}&webPass=${encodeURIComponent(webPass)}`
                });

                if (res.ok) {
                    alertToast("success", "Authentication settings saved");
                } else {
                    alertToast("error", "Save failed: " + res.status);
                }
            } catch (err) {
                alertToast("error", "Request failed");
            }
        });

        async function loadAuthConfig() {
            try {
                const res = await fetch("/config.json");
                const config = await res.json();
                document.getElementById("webUser").value = config.webUser || "";
                // Don't populate password fields for security
            } catch (err) {
                console.warn("Failed to load config");
            }
        }

        buildNavMenu();
        loadAuthConfig();

        // WebSocket for live status updates
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                const ledReasonEl = document.getElementById("ledReason");
                const printerStateEl = document.getElementById("printerState");
                if (ledReasonEl) ledReasonEl.textContent = data.ledReason || "--";
                if (printerStateEl) {
                    let state = data.printerConnection ? (data.gcodeState || "Connected") : "Offline";
                    if (data.printerConnection && data.gcodeState === "RUNNING" && data.printProgress > 0) {
                        state = "Printing " + data.printProgress + "%";
                    } else if (state && state === state.toUpperCase()) {
                        state = state.charAt(0) + state.slice(1).toLowerCase();
                    }
                    printerStateEl.textContent = state;
                }
            } catch (error) { }
        };
    </script>

</body>

</html>
