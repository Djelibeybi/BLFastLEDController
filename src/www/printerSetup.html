<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>BLFLC Printer Setup</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <canvas id="particleCanvas" style="background: rgb(20,80,49);"></canvas>
    <div id="container">
        <div id="header">
            <img id="logo" src="/blflc.svg" alt="BLFLC Logo">
            <h1>Printer Setup</h1>
        </div>

        <nav class="nav-menu" id="navMenu"></nav>

        <div id="networkStatus" class="network" style="padding: 10px; margin-bottom: 15px; background: #f5f5f5; border-radius: 4px;">
            Loading network status...
        </div>

        <form id="printerForm">
            <label for="printerIP">Printer IP</label>
            <div style="display: flex; gap: 6px; align-items: center;">
                <input type="text" id="printerIP" placeholder="e.g. 192.168.1.100" style="flex: 2;">
                <button type="button" id="openPrinterList" title="Search printer"
                    style="flex: 1; margin-bottom: 8px; background-color: #28a745; cursor: pointer; padding: 8px 12px;">
                    Discover
                </button>
            </div>

            <label for="printerSerial">Printer Serial Number</label>
            <input type="text" id="printerSerial" placeholder="e.g. 00M00A000000000">

            <label for="accessCode">Printer Access Code</label>
            <input type="text" id="accessCode" placeholder="8-digit code from printer">

            <button type="submit">Save</button>
        </form>

        <div id="status-bar">
            <span id="status-led">LED: <span id="ledReason">--</span></span>
            <span id="status-printer">Printer: <span id="printerState">--</span></span>
        </div>
    </div>

    <script src="particleCanvas.js"></script>
    <div id="toast"><span id="toast-icon"></span><span id="toast-msg">Placeholder</span></div>
    <div id="printerModal" style="
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.4);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    ">
        <div style="
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        ">
            <h3 style="margin-top: 0;">Select Printer</h3>
            <div id="printerList" style="max-height: 300px; overflow-y: auto;"></div>
            <div style="text-align: right; margin-top: 10px;">
                <button onclick="closePrinterModal()">Close</button>
            </div>
        </div>
    </div>
    <script>
        let isEthernet = false;

        function alertToast(type, message) {
            const toast = document.getElementById("toast");
            const icon = document.getElementById("toast-icon");
            const msg = document.getElementById("toast-msg");

            let iconChar = "i";
            let color = "#333";

            switch (type.toLowerCase()) {
                case "success": iconChar = "OK"; color = "#28a745"; break;
                case "error": iconChar = "X"; color = "#dc3545"; break;
                case "warning": iconChar = "!"; color = "#ffc107"; break;
                case "info": default: iconChar = "i"; color = "#17a2b8";
            }

            toast.style.backgroundColor = color;
            icon.textContent = iconChar;
            msg.textContent = message;
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 3000);
        }

        function buildNavMenu() {
            const nav = document.getElementById("navMenu");
            const currentPage = window.location.pathname;

            let links = [
                { href: "/", label: "LEDs" },
                { href: "/printer", label: "Printer" },
                { href: "/auth", label: "Auth" },
                { href: "/debug", label: "Debug" },
                { href: "/advanced", label: "Advanced" }
            ];

            // WiFi link only shown if networkType is wifi
            if (!isEthernet) {
                links.splice(1, 0, { href: "/wifi", label: "WiFi" });
            }

            nav.innerHTML = links.map(link =>
                `<a href="${link.href}" class="${currentPage === link.href ? 'active' : ''}">${link.label}</a>`
            ).join("");
        }

        async function loadNetworkStatus() {
            try {
                const res = await fetch("/config.json");
                const config = await res.json();
                const statusDiv = document.getElementById("networkStatus");

                isEthernet = config.networkType === "ethernet";

                if (isEthernet) {
                    statusDiv.innerHTML = `<strong>Ethernet Connected</strong> (${config.linkSpeed || '?'} Mbps)<br>Device IP: ${config.deviceIP || 'Awaiting DHCP...'}`;
                } else {
                    statusDiv.innerHTML = `<strong>WiFi:</strong> ${config.ssid || 'Not configured'}`;
                }

                // Build nav after we know the network type
                buildNavMenu();
            } catch (err) {
                document.getElementById("networkStatus").innerHTML = "Network status unavailable";
                buildNavMenu();
            }
        }

        document.getElementById("printerForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const printerIP = document.getElementById("printerIP").value;
            const printerSerial = document.getElementById("printerSerial").value.trim().toUpperCase();
            const accessCode = document.getElementById("accessCode").value;

            try {
                const res = await fetch("/submitPrinter", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `printerIP=${encodeURIComponent(printerIP)}&printerSerial=${encodeURIComponent(printerSerial)}&accessCode=${encodeURIComponent(accessCode)}`
                });

                if (res.ok) {
                    alertToast("success", "Printer settings saved. Restarting...");
                } else {
                    alertToast("error", "Save failed: " + res.status);
                }
            } catch (err) {
                alertToast("info", "Device is likely restarting.");
            }
        });

        async function loadPrinterConfig() {
            try {
                const res = await fetch("/config.json");
                const config = await res.json();
                document.getElementById("printerIP").value = config.printerIP || "";
                document.getElementById("printerSerial").value = config.printerSerial || "";
                document.getElementById("accessCode").value = config.accessCode || "";
            } catch (err) {
                console.warn("No existing config found or failed to load.");
            }
        }

        async function loadPrinters() {
            const list = document.getElementById("printerList");
            list.innerHTML = "Searching...";

            try {
                const res = await fetch("/printerList");
                const printers = await res.json();

                if (printers.length === 0) {
                    list.innerHTML = "<p>No printers found on the network.</p>";
                    return;
                }

                list.innerHTML = "";
                printers.forEach(printer => {
                    const div = document.createElement("div");
                    div.textContent = `${printer.ip} (${printer.usn})`;
                    div.style.padding = "8px";
                    div.style.borderBottom = "1px solid #ddd";
                    div.style.cursor = "pointer";

                    div.addEventListener("click", () => {
                        document.getElementById("printerIP").value = printer.ip;
                        document.getElementById("printerSerial").value = printer.usn;
                        closePrinterModal();
                        alertToast("success", "Printer selected");
                    });

                    list.appendChild(div);
                });
            } catch (err) {
                list.innerHTML = "<p>Failed to discover printers.</p>";
            }
        }

        function openPrinterModal() {
            loadPrinters();
            document.getElementById("printerModal").style.display = "flex";
        }

        function closePrinterModal() {
            document.getElementById("printerModal").style.display = "none";
        }

        document.getElementById("openPrinterList").addEventListener("click", openPrinterModal);

        loadPrinterConfig();
        loadNetworkStatus();

        // WebSocket for live status updates
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                const ledReasonEl = document.getElementById("ledReason");
                const printerStateEl = document.getElementById("printerState");
                if (ledReasonEl) ledReasonEl.textContent = data.ledReason || "--";
                if (printerStateEl) {
                    let state = data.printerConnection ? (data.gcodeState || "Connected") : "Offline";
                    if (data.printerConnection && data.gcodeState === "RUNNING" && data.printProgress > 0) {
                        state = "Printing " + data.printProgress + "%";
                    } else if (state && state === state.toUpperCase()) {
                        state = state.charAt(0) + state.slice(1).toLowerCase();
                    }
                    printerStateEl.textContent = state;
                }
            } catch (error) { }
        };
    </script>

</body>

</html>
