<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>BLFLC Advanced</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <canvas id="particleCanvas" style="background: rgb(20,80,49);"></canvas>
    <div id="container">
        <div id="header">
            <img id="logo" src="/blflc.svg" alt="BLFLC Logo">
            <h1>Advanced</h1>
        </div>

        <nav class="nav-menu" id="navMenu"></nav>

        <div class="form-container" style="padding: 15px;">
            <h4 style="margin-top: 0; color: #333;">Network</h4>
            <form id="hostnameForm" style="margin-bottom: 15px;">
                <label for="hostname">mDNS Hostname</label>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="text" id="hostname" name="hostname" maxlength="31" pattern="[a-zA-Z0-9\-]+"
                        style="flex: 1;" placeholder="blflc">
                    <span style="color: #666;">.local</span>
                </div>
                <p style="margin: 5px 0 10px 0; color: #666; font-size: 12px;">
                    Access this device at <span id="hostnamePreview">blflc</span>.local
                </p>
                <button type="submit">Save Hostname</button>
            </form>

            <h4 style="color: #333;">Firmware</h4>
            <button type="button" onclick="location.href='/fwupdate'">Firmware Update</button>

            <h4 style="color: #333;">Configuration</h4>
            <button type="button" onclick="location.href='/backuprestore'">Backup & Restore</button>

            <h4 style="color: #333;">System</h4>
            <button type="button" onclick="window.open('/webserial','_blank')" style="background-color: #17a2b8;">
                Web Serial Log
            </button>
            <button type="button" onclick="confirmReboot()" style="background-color: #ffc107; color: #333;">
                Reboot Device
            </button>
            <button type="button" onclick="confirmFactoryReset()" style="background-color: #dc3545;">
                Factory Reset
            </button>
        </div>

        <h4 id="firmwareversion" style="color: white; text-align: center;">Firmware version: ??.??.??</h4>

        <div id="status-bar">
            <span id="status-led">LED: <span id="ledReason">--</span></span>
            <span id="status-printer">Printer: <span id="printerState">--</span></span>
        </div>
    </div>

    <script src="particleCanvas.js"></script>
    <div id="toast"><span id="toast-icon"></span><span id="toast-msg">Placeholder</span></div>
    <script>
        let isEthernet = false;

        function alertToast(type, message) {
            const toast = document.getElementById("toast");
            const icon = document.getElementById("toast-icon");
            const msg = document.getElementById("toast-msg");

            let iconChar = "i";
            let color = "#333";

            switch (type.toLowerCase()) {
                case "success": iconChar = "OK"; color = "#28a745"; break;
                case "error": iconChar = "X"; color = "#dc3545"; break;
                case "warning": iconChar = "!"; color = "#ffc107"; break;
                case "info": default: iconChar = "i"; color = "#17a2b8";
            }

            toast.style.backgroundColor = color;
            icon.textContent = iconChar;
            msg.textContent = message;
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 3000);
        }

        function buildNavMenu() {
            const nav = document.getElementById("navMenu");
            const currentPage = window.location.pathname;

            let links = [
                { href: "/", label: "LEDs" },
                { href: "/printer", label: "Printer" },
                { href: "/auth", label: "Auth" },
                { href: "/debug", label: "Debug" },
                { href: "/advanced", label: "Advanced" }
            ];

            if (!isEthernet) {
                links.splice(1, 0, { href: "/wifi", label: "WiFi" });
            }

            nav.innerHTML = links.map(link =>
                `<a href="${link.href}" class="${currentPage === link.href ? 'active' : ''}">${link.label}</a>`
            ).join("");
        }

        async function loadConfig() {
            try {
                const res = await fetch("/config.json");
                const config = await res.json();

                isEthernet = config.networkType === "ethernet";
                document.getElementById("firmwareversion").textContent = "Firmware version: " + (config.firmwareversion || "Unknown");

                // Load hostname
                const hostname = config.hostname || "blflc";
                document.getElementById("hostname").value = hostname;
                document.getElementById("hostnamePreview").textContent = hostname;

                buildNavMenu();
            } catch (err) {
                console.warn("Failed to load config");
                buildNavMenu();
            }
        }

        // Update preview as user types
        document.getElementById("hostname").addEventListener("input", function(e) {
            const value = e.target.value.toLowerCase().replace(/[^a-z0-9\-]/g, '') || "blflc";
            document.getElementById("hostnamePreview").textContent = value;
        });

        // Handle hostname form submission
        document.getElementById("hostnameForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            let hostname = document.getElementById("hostname").value.toLowerCase().replace(/[^a-z0-9\-]/g, '');
            if (!hostname) hostname = "blflc";

            try {
                const res = await fetch("/submitHostname", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `hostname=${encodeURIComponent(hostname)}`
                });

                if (res.ok) {
                    alertToast("success", "Hostname saved. Reboot to apply.");
                    document.getElementById("hostname").value = hostname;
                    document.getElementById("hostnamePreview").textContent = hostname;
                } else {
                    alertToast("error", "Save failed: " + res.status);
                }
            } catch (err) {
                alertToast("error", "Request failed");
            }
        });

        function confirmReboot() {
            if (confirm("Are you sure you want to reboot the device?")) {
                fetch('/reboot')
                    .then(() => {
                        alertToast("info", "Rebooting device...");
                        setTimeout(() => location.reload(), 5000);
                    })
                    .catch(() => {
                        alertToast("info", "Device is rebooting...");
                        setTimeout(() => location.reload(), 5000);
                    });
            }
        }

        function confirmFactoryReset() {
            if (confirm("WARNING: This will erase all settings and restore factory defaults.\n\nAre you sure you want to continue?")) {
                if (confirm("This action cannot be undone. Confirm factory reset?")) {
                    fetch('/factoryreset')
                        .then(() => {
                            alertToast("warning", "Factory reset initiated...");
                            setTimeout(() => location.reload(), 5000);
                        })
                        .catch(() => {
                            alertToast("info", "Device is resetting...");
                            setTimeout(() => location.reload(), 5000);
                        });
                }
            }
        }

        loadConfig();

        // WebSocket for live status updates
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                const ledReasonEl = document.getElementById("ledReason");
                const printerStateEl = document.getElementById("printerState");
                if (ledReasonEl) ledReasonEl.textContent = data.ledReason || "--";
                if (printerStateEl) {
                    let state = data.printerConnection ? (data.gcodeState || "Connected") : "Offline";
                    if (data.printerConnection && data.gcodeState === "RUNNING" && data.printProgress > 0) {
                        state = "Printing " + data.printProgress + "%";
                    } else if (state && state === state.toUpperCase()) {
                        state = state.charAt(0) + state.slice(1).toLowerCase();
                    }
                    printerStateEl.textContent = state;
                }
            } catch (error) { }
        };
    </script>

</body>

</html>
